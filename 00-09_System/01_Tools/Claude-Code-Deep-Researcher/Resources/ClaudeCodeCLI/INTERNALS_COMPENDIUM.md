# Internals Compendium: Advanced Architectures

**Status**: Deep Technical Analysis (Reverse Engineered)
**Target**: Power Users & Platform Developers

This document details the hidden mechanisms of the Claude Code CLI, focusing on Context Management, Tool Execution, and the Main Loop.

## 1. Context Management Strategy

The CLI employs a **Middle-Out Context Compression** algorithm to manage the limited context window of the LLM while preserving the most critical information.

### The Algorithm
When the conversation history exceeds a specific threshold (2000 messages), the CLI "squeezes" the middle of the conversation out, prioritizing the start (Instructions) and the end (Recent Actions).

**Parameters:**
- `THRESHOLD`: **2000 messages** (`rJ5`)
- `KEEP_HEAD`: **1000 messages** (`Xk2`)
- `KEEP_TAIL`: **1000 messages** (`Xk2`)

**Logic:**
```javascript
if (messages.length <= 2000) {
  return messages;
} else {
  return [
    ...messages.slice(0, 1000),  // Initial Context & System Prompt
    ...messages.slice(-1000)     // Recent History & Tool Results
  ];
}
```
*Note: This is a message-count heuristic, distinct from token-counting.*

## 2. Tool Execution Architecture

The CLI wraps external binaries to provide robust tool capabilities.

### 2.1 Ripgrep (`rg`) Wrapper
The CLI contains a **Built-in Ripgrep** integration but can fall back to the system binary.

-   **Modes**:
    -   `builtin`: Uses `process.execPath` with `["--ripgrep"]` (Self-execution).
    -   `system`: Uses `rg` from `$PATH`.
-   **Resilience**:
    -   Detects `EAGAIN` (Resource temporarily unavailable) errors.
    -   **Retry Strategy**: Retries failed searches with `-j 1` (Single-threaded) to reduce system load.
-   **Security**:
    -   Explicitly excludes `**/node_modules/**` to prevent massive token usage from dependency trees.
    -   Respects `.gitignore` and `.ignore`.

### 2.2 Git Integration
-   **State Tracking**: Tracks `hasUncommitted` and `gitBranch` metadata per turn.
-   **Auto-Commit**: The `laQ` function suggests "Background task" handling for operations like committing or pushing.

## 3. Session State Machine (`SH5`)

The function `SH5` acts as the session "Hydrator". It determines the starting state of the CLI.

**Flow:**
1.  **Input Analysis**: Checks flags (`--resume`, `--continue`, `--teleport`).
2.  **Hydration**:
    -   **Resume**: Calls `bc2` to resolve UUID/File/URL.
    -   **Continue**: Calls `Dl` to load the last session from the current project context.
    -   **Teleport**: Forking a session from a specific point in time (Time Travel).
3.  **State Reconstruction**:
    -   Replays the `.jsonl` log to rebuild the `messages` array.
    -   Restores `fileHistorySnapshots` for the Undo/Rewind capability.

## 4. File Checkpointing (Time Travel)

The CLI implements a "Rewind" feature (`pc2` function) that allows users to undo file changes made by the AI.

-   **Mechanism**: It tracks `fileHistory` in the session state.
-   **Action**: When a rewind is requested for a specific message ID:
    1.  Locates the checkpoint associated with that message.
    2.  Uses `kNA` (likely a file system transaction manager) to revert files to their previous state.
    3.  Updates the session history to reflect the undo.

## 5. Telemetry & Observability

-   **Datadog**: Pushes logs to `http-intake.logs.datadoghq.com`.
-   **Sentry**: Error tracking.
-   **Segment**: Usage analytics (`tengu_*` events).
-   **Sanitization**: Cleans PII/Secrets before logging.

## 6. System Prompt

The default persona is injected via a hidden system prompt:
> "You are Claude Code, Anthropic's official CLI for Claude."

This is followed by dynamic context instructions generated by `getSystemPrompt`, which includes:
-   Tool definitions.
-   Project-specific instructions (from `~/.claude/projects/...`).
-   User's custom instructions.
